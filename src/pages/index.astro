---
import Layout from '../layouts/Layout.astro';
import Card from '../components/ui/card.astro';
import Badge from '../components/ui/badge.astro';
import Tabs from '../components/ui/tabs.astro';
import TabsList from '../components/ui/tabs-list.astro';
import TabsTrigger from '../components/ui/tabs-trigger.astro';
import TabsContent from '../components/ui/tabs-content.astro';

const base = import.meta.env.BASE_URL.replace(/\/$/, '');

const experienceFiles = await Astro.glob('./experience/*.md');
const experiences = experienceFiles.map((file) => ({
  title: file.frontmatter.title,
  organization: file.frontmatter.organization,
  role: file.frontmatter.role,
  category: file.frontmatter.category,
  duration: file.frontmatter.duration,
  commitCount: file.frontmatter.commit_count,
  tech: file.frontmatter.tech || [],
  url: file.url,
})).sort((a, b) => (b.commitCount || 0) - (a.commitCount || 0));
---

<Layout>
  <main class="container relative mx-auto scroll-my-12 overflow-auto p-4 print:p-11 md:p-16">
    <div class="mx-auto w-full max-w-3xl space-y-8 bg-white">
      <header class="space-y-4">
        <div class="flex items-start justify-between">
          <div>
            <h1 class="text-3xl font-bold">Máximo García</h1>
            <p class="text-foreground/70">Portfolio & Applications</p>
          </div>
          <a
            href={`${base}/download-avatar`}
            class="rounded-md border px-3 py-1.5 text-sm font-medium transition-colors hover:bg-foreground/5 print:hidden"
          >
            Download Avatar
          </a>
        </div>

        <Tabs defaultValue="applications" class="w-full print:hidden">
          <TabsList class="w-full justify-start">
            <TabsTrigger value="applications">Applications</TabsTrigger>
            <TabsTrigger value="experience">My Experience</TabsTrigger>
          </TabsList>

          <TabsContent value="applications" class="space-y-6">
            <!-- MAX IV Application -->
            <Card class="p-6">
              <div class="space-y-4">
                <div class="flex items-start justify-between">
                  <div>
                    <h2 class="text-xl font-semibold">Fullstack Web Developer</h2>
                    <p class="text-sm text-foreground/70">MAX IV, Lunds universitet</p>
                  </div>
                  <Badge>Active</Badge>
                </div>

                <div class="flex gap-4 text-sm text-foreground/60">
                  <span>Posted: Sep 15, 2025</span>
                  <span>Deadline: Oct 5, 2025</span>
                </div>

                <div class="grid gap-2 sm:grid-cols-4">
                  <a
                    href={`${base}/maxiv/job-post`}
                    class="rounded-md border px-4 py-2 text-center text-sm font-medium transition-colors hover:bg-foreground/5"
                  >
                    Job Posting
                  </a>
                  <a
                    href={`${base}/maxiv/cover-letter`}
                    class="rounded-md border px-4 py-2 text-center text-sm font-medium transition-colors hover:bg-foreground/5"
                  >
                    Cover Letter
                  </a>
                  <a
                    href={`${base}/maxiv/cv`}
                    class="rounded-md border px-4 py-2 text-center text-sm font-medium transition-colors hover:bg-foreground/5"
                  >
                    CV
                  </a>
                  <a
                    href={`${base}/maxiv/application-form-data`}
                    class="rounded-md border px-4 py-2 text-center text-sm font-medium transition-colors hover:bg-foreground/5"
                  >
                    Form Data
                  </a>
                </div>
              </div>
            </Card>

            <!-- IKEA Application -->
            <Card class="p-6">
              <div class="space-y-4">
                <div class="flex items-start justify-between">
                  <div>
                    <h2 class="text-xl font-semibold">Senior Fullstack Developer</h2>
                    <p class="text-sm text-foreground/70">IKEA</p>
                  </div>
                  <Badge variant="secondary">Draft</Badge>
                </div>

                <div class="grid gap-2 sm:grid-cols-3">
                  <a
                    href={`${base}/ikea-senior-fullstack`}
                    class="rounded-md border px-4 py-2 text-center text-sm font-medium transition-colors hover:bg-foreground/5"
                  >
                    CV
                  </a>
                </div>
              </div>
            </Card>
          </TabsContent>

          <TabsContent value="experience" class="space-y-6">
            <div class="space-y-4">
              <p class="text-sm text-foreground/70">
                {experiences.length} projects sorted by commit count
              </p>

              {experiences.map((exp) => (
                <Card class="p-6">
                  <div class="space-y-3">
                    <div class="flex items-start justify-between gap-4">
                      <div class="flex-1">
                        <a href={exp.url} class="group">
                          <h3 class="text-lg font-semibold group-hover:underline">
                            {exp.title}
                          </h3>
                        </a>
                        <p class="text-sm text-foreground/70">{exp.organization}</p>
                        {exp.role && (
                          <p class="text-xs text-foreground/60">{exp.role}</p>
                        )}
                      </div>
                      <div class="text-right">
                        {exp.commitCount && (
                          <Badge variant="secondary" class="text-xs">
                            {exp.commitCount} commits
                          </Badge>
                        )}
                      </div>
                    </div>

                    {exp.duration && (
                      <div class="text-xs text-foreground/60">
                        {exp.duration.human}
                      </div>
                    )}

                    {exp.tech && exp.tech.length > 0 && (
                      <div class="flex flex-wrap gap-1">
                        {exp.tech.slice(0, 5).map((tech: string) => (
                          <span class="rounded-md bg-foreground/5 px-2 py-1 text-xs font-mono">
                            {tech}
                          </span>
                        ))}
                      </div>
                    )}
                  </div>
                </Card>
              ))}
            </div>
          </TabsContent>
        </Tabs>
      </header>
    </div>
  </main>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const tabsContainer = document.querySelector('[data-tabs]');
    if (!tabsContainer) return;

    const defaultValue = tabsContainer.getAttribute('data-default-value') || 'applications';
    const triggers = tabsContainer.querySelectorAll('[data-tabs-trigger]');
    const contents = tabsContainer.querySelectorAll('[data-tabs-content]');

    function activateTab(value: string) {
      triggers.forEach(trigger => {
        const triggerValue = trigger.getAttribute('data-value');
        if (triggerValue === value) {
          trigger.setAttribute('data-state', 'active');
        } else {
          trigger.setAttribute('data-state', 'inactive');
        }
      });

      contents.forEach(content => {
        const contentValue = content.getAttribute('data-value');
        if (contentValue === value) {
          content.classList.remove('hidden');
        } else {
          content.classList.add('hidden');
        }
      });

      window.location.hash = value;
    }

    triggers.forEach(trigger => {
      trigger.addEventListener('click', () => {
        const value = trigger.getAttribute('data-value');
        if (value) activateTab(value);
      });
    });

    const initialTab = window.location.hash.slice(1) || defaultValue;
    activateTab(initialTab);
  });
</script>
